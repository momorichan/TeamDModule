<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="product">
	<insert id="add" parameterType="pvo">
		insert into product
		values(product_seq.nextval, #{pname}, #{price},
		#{scnum}, #{stock},
		#{pdetail}, #{image}, #{image2}, #{image3})
	</insert>
	<select id="lclist" resultType="lcvo">
		select lcnum, lcname from
		lcategory
	</select>
	<select id="sclist" resultType="scvo" parameterType="int">
		select
		scnum, lcnum, scname from scategory where lcnum = #{lcnum}
	</select>


	<select id="prlist" resultType="pvo" parameterType="map">
		select pnum, pname, image, price
		from (
		select rownum r_num, p.* from (
		select p.pnum, p.pname, p.image, p.price
		from product p
		join scategory s
		ON p.scnum = s.scnum
		<if test="lcnum != null or scnum != null">
			<where>
				<choose>
					<when test="lcnum != null">
						s.lcnum = #{lcnum}
					</when>
					<when test="scnum != null">
						s.scnum = #{scnum}
					</when>
				</choose>
			</where>
			<if test="searchValue != null">
				pname like '%'||#{searchValue}||'%'
			</if>
		</if>
		order by 1 desc
		) p
		)
		where r_num between #{begin} and #{end}
	</select>


	<select id="totalCount" resultType="int" parameterType="map">
		select count(*) cnt from product
		<where>
			<choose>
				<when test="lcnum != null">
					scnum IN (SELECT scnum FROM scategory WHERE lcnum = #{lcnum})
				</when>
				<when test="scnum != null">
					scnum  = #{scnum}
				</when>		
				<when test="lcnum != null and scnum != null">
					scnum IN 
					(SELECT scnum FROM scategory WHERE lcnum = 
					 (SELECT lcnum FROM scategory WHERE scnum = #{scnum}))
				</when>		
			</choose>
		</where>
	</select>
	
	
	<select id="SearchByCategory" parameterType="map" resultType="pvo">
		select pnum, pname, image, price 
		from product
		( select rownum r_num, p.* from ( select pnum, pname, image, price from product 
		<where>
			<choose>
				<when test="lcnum != null">
					scnum IN (SELECT scnum FROM scategory WHERE lcnum = #{lcnum})
				</when>
				<when test="scnum != null">
					scnum  = #{scnum}
				</when>		
				<when test="lcnum != null and scnum != null">
					scnum IN 
					(SELECT scnum FROM scategory WHERE lcnum = 
					 (SELECT lcnum FROM scategory WHERE scnum = #{scnum}))
				</when>		
			</choose>
		</where>
		order by pnum desc 
		) p
		) 
		where p.r_num between #{begin} and #{end}
	</select>
</mapper>
